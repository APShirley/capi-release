#!/bin/bash -exu

function main() {
  local pgversion
  pgversion="postgresql-9.4.6"

  tar xzf "postgres/${pgversion}.tar.gz"

  pushd "${pgversion}" > /dev/null
    if [ "`uname -m`" == "ppc64le" ]; then
      cp "${BOSH_COMPILE_TARGET}/architecture-support/config/config.{guess,sub}" ./config
    fi

    ./configure --prefix="${BOSH_INSTALL_TARGET}"

    pushd src/bin/pg_config > /dev/null
      make
      make install
    popd > /dev/null

    cp -LR src/include "${BOSH_INSTALL_TARGET}"

    pushd src/interfaces/libpq > /dev/null
      make
      make install
    popd > /dev/null
  popd > /dev/null
}

main
